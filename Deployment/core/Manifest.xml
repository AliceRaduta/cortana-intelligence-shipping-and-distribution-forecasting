<?xml version="1.0" encoding="utf-8"?>
<Template>
  <Title>Demand Forecasting for Shipping and Distribution</Title>
  <Owner displayname="Business Operations and Economics Group" email="erwright@microsoft.com" />
  <PublishedOn>06/01/2017</PublishedOn>
  <ImageUrl>{PatternAssetBaseUrl}/image.png</ImageUrl>
  <Description>
    The Demand Forecasting for Shipping and Distribution Solution uses historical demand data to forecast demand in future periods across varios customers, products and destinations. For instance, a shipping or delivery company wants to predict the quantities of the different products its customers want delivered at different locations at future times. A company can use these forecasts as input to an allocation tool that optimizes operations, such as delivery vehicles routing, or to plan capacity in the longer term.
  </Description>
  <!--<LongDescription></LongDescription>
  <Partners>
  </Partners>-->
  <Summary>
    <Tabs>
      <Tab src="markdown\Summary.md" format="markdown" title="Description" />
    </Tabs>
  </Summary>
  <!--<TryItNow url="" />-->
  <EstimatedTime>15 Minutes</EstimatedTime>
  <Ingredients>
    <Ingredient>DataFactory</Ingredient>
    <Ingredient>MachineLearning</Ingredient>
    <Ingredient>Sql</Ingredient>
    <Ingredient>StorageAccount</Ingredient>
    <Ingredient>PowerBi</Ingredient>
  </Ingredients>
  <Tags>
    <Tag>Operations Management</Tag>
    <Tag>Cortana Intelligence</Tag>
    <Tag>Demand Forecasting</Tag>
  </Tags>
  <Feedback email="erwright@microsoft.com" />

  <ProvisioningSteps> 
    <Manual parameterSource="SqlDeploy.json" title="Setup SQL Server Account">
      <Parameters>
        <Credential type="sql" username="sqlServerUser" password="sqlServerPasswd" />
      </Parameters>
    </Manual>

    <ArmDeployment source="SqlDeploy.json" title="Deploying SQL Server Resources" autoResolveParameters="true" />
    
    <AzureFunctionApp alwaysOn="false" use32BitWorkerProcess="false" servicePlanSku="B2" servicePlanTier="Basic" createStorageAccount="true">
      <AppSettings>
        <!-- Uncomment the below settings and set createStorageAccount to true to enable Azure Functions debugging features -->
        <Add key="AzureWebJobsStorage" value="DefaultEndpointsProtocol=https;AccountName={Outputs.storageAccountName};AccountKey={Outputs.storageAccountKey}" />
        <Add key="AzureWebJobsDashboard" value="DefaultEndpointsProtocol=https;AccountName={Outputs.storageAccountName};AccountKey={Outputs.storageAccountKey}" />
      </AppSettings>
    </AzureFunctionApp>

    <Function name="BlobStorageSetup" title="Configuring Blob Storage">
      <Parameters>
        <Parameter name="storageAccountName" defaultValue="{Outputs.storageAccountName}" hidden="true" />
        <Parameter name="storageAccountKey" defaultValue="{Outputs.storageAccountKey}" hidden="true" />
        <Parameter name="amlModulePath" defaultValue="{PatternAssetBaseUrl}\DemandForecast.zip" hidden="true" />
        <Parameter name="amlModuleContainerName" defaultValue="modules" hidden="true" />
        <Parameter name="adfContainerName" defaultValue="adf-blob-landing" hidden="true" />
      </Parameters>
    </Function>

    <Function name="SqlDbSetup" title="Creating SQL Database Objects">
      <Parameters>
        <Parameter name="sqlServerName" defaultValue="{Outputs.sqlServerName}"  hidden="true" />
        <Parameter name="sqlServerUser" defaultValue="{Inputs.sqlServerUser}"  hidden="true" />
        <Parameter name="sqlServerPasswd" defaultValue="{Inputs.sqlServerPasswd}"  hidden="true" />
        <Parameter name="sqlDbName" defaultValue="{Outputs.sqlDbName}"  hidden="true" />
        <Parameter name="sqlScriptPath" defaultValue="{PatternAssetBaseUrl}\CreateDatabaseObjects.sql"  hidden="true" />
        <Parameter name="demandDataPath" defaultValue="{PatternAssetBaseUrl}\ExampleDemandData.csv"  hidden="true" />
        <Parameter name="forecastWindowMonthsBack" type="int" defaultValue="3" hidden="true" />
        <Parameter name="forecastWindowMonthsForward" type="int" defaultValue="1" hidden="true" />
      </Parameters>
    </Function>

    <ArmDeployment source="FcastMlDeploy.json" title="Deploying ML Webservice">
      <Parameters>
        <Parameter name="storageAccountName" defaultValue="{Outputs.storageAccountName}" hidden="true" />
        <Parameter name="storageAccountKey" defaultValue="{Outputs.storageAccountKey}" hidden="true" />
        <Parameter name="codeModuleUri" defaultValue="{Outputs.amlModuleUri}" hidden="true" />
      </Parameters>
    </ArmDeployment>

    <Function name="GetMLApiKey" title="Retrieving ML Webservice Credentials">
      <Parameters>
        <Parameter name="subscriptionId" defaultValue="{SubscriptionId}"  hidden="true" />
        <Parameter name="resourceGroupName" defaultValue="{ResourceGroup.Name}"  hidden="true" />
        <Parameter name="webServiceName" defaultValue="{Outputs.mlWebServiceName}"  hidden="true" />
        <Parameter name="authorizationToken" type="string" defaultValue="{Authorization}" hidden="true" />
      </Parameters>
    </Function>

    <ArmDeployment source="DataFactoryDeploy.json" title="Deploying Data Factory">
      <Parameters>
        <Parameter name="sqlServerName" defaultValue="{Outputs.sqlServerName}" hidden="true" />
        <Parameter name="sqlServerUser" defaultValue="{Inputs.sqlServerUser}" hidden="true" />
        <Parameter name="sqlServerPasswd" defaultValue="{Inputs.sqlServerPasswd}" hidden="true" />
        <Parameter name="sqlDbName" defaultValue="{Outputs.sqlDbName}" hidden="true" />
        <Parameter name="storageAccountName" defaultValue="{Outputs.storageAccountName}" hidden="true" />
        <Parameter name="storageAccountKey" defaultValue="{Outputs.storageAccountKey}" hidden="true" />
        <Parameter name="mlBESEndpointUrl" defaultValue="{Outputs.mLEndpointBatchLocation}" hidden="true" />
        <Parameter name="mlApiKey" defaultValue="{Outputs.mLEndpointKey}" hidden="true" />
        <Parameter name="blobLandingContainer" defaultValue="{Outputs.adfContainerName}" hidden="true" />
      </Parameters>
    </ArmDeployment>

    <Function name="StartPipelines" title="Activating Data Factory Pipelines">
      <Parameters>
        <Parameter name="subscriptionId" defaultValue="{SubscriptionId}"  hidden="true" />
        <Parameter name="resourceGroupName" defaultValue="{ResourceGroup.Name}"  hidden="true" />
        <Parameter name="dataFactoryName" defaultValue="{Outputs.dataFactoryName}"  hidden="true" />
        <Parameter name="authorizationToken" type="string" defaultValue="{Authorization}" hidden="true" />
        <Parameter name="pipelineStartDate" defaultValue="{Outputs.forecastWindowStart}" hidden="true" />
        <Parameter name="pipelineEndDate" defaultValue="{Outputs.forecastWindowEnd}" hidden="true" />
      </Parameters>
    </Function>

    <SolutionDashboard>
      <Parameters>
        <Parameter hidden="true" name="pbixFileUrl" defaultValue="{PatternAssetBaseUrl}\dashboard.pbix" />
        <Parameter hidden="true" name="sqlServer" defaultValue="{Outputs.sqlServerName}" />
        <Parameter hidden="true" name="sqlDatabase" defaultValue="{Outputs.sqlDbName}" />
        <Parameter hidden="true" name="sqlServerUsername" defaultValue="{Inputs.sqlServerUser}" />
        <Parameter hidden="true" name="sqlServerPassword" defaultValue="{Inputs.sqlServerPasswd}" />
      </Parameters>
    </SolutionDashboard>

    <Manual title="Done">
      <Instructions src="markdown\Instructions.md" format="markdown" />
    </Manual>
  </ProvisioningSteps>
</Template>